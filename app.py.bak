"""
WIZX Agricultural Commodity Price Platform

A comprehensive platform for tracking, analyzing, and pricing
agricultural commodities with advanced quality assessment.
"""

import os
import streamlit as st
import pandas as pd
import plotly.express as px
import plotly.graph_objects as go
from datetime import datetime, timedelta, date
import logging
import json
import random
import time

# Configure logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Import core functionality
from database_sql import (
    initialize_database,
    get_all_commodities,
    get_commodity_prices,
    get_top_commodities,
    get_commodity_index_data,
    get_regions_for_commodity
)
from utils.format_utils import (
    format_price,
    format_delta,
    format_percent,
    format_large_number,
    format_date
)
from wizx_index import get_wizx_index
from quality_analyzer import analyze_commodity_quality
from pricing_engine import calculate_price

# Set page configuration
st.set_page_config(
    page_title="WIZX Agricultural Commodity Platform",
    page_icon="ðŸŒ¾",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Initialize the database if needed
def init_database():
    with st.spinner("Initializing database..."):
        initialize_database()
        st.success("Database initialized successfully!")
        time.sleep(2)
        st.rerun()


#------------------
# UI Components
#------------------

def render_header():
    """Render the application header"""
    col1, col2, col3 = st.columns([1, 5, 1])
    
    with col1:
        st.image("https://raw.githubusercontent.com/streamlit/streamlit/develop/examples/potato-classifier/streamlit-logo-secondary-colormark-darktext.png", width=100)
    
    with col2:
        st.markdown("""
        <h1 style='text-align: center; color: #0F4C81;'>WIZX Agricultural Commodity Platform</h1>
        <p style='text-align: center;'>Advanced agricultural commodity pricing with quality assessment</p>
        """, unsafe_allow_html=True)
    
    with col3:
        current_date = datetime.now()
        st.markdown(f"**{current_date.strftime('%d %b %Y')}**")


def render_sidebar():
    """Render the application sidebar"""
    st.sidebar.title("Navigation")
    
    # Get available commodities
    commodities = get_all_commodities()
    
    if not commodities:
        # Database not initialized yet
        st.sidebar.warning("Database not initialized. Please initialize first.")
        if st.sidebar.button("Initialize Database"):
            init_database()
        return None, None
    
    # Add "All" option for the dashboard view
    commodities = ["All"] + commodities
    
    # Commodity selection
    selected_commodity = st.sidebar.selectbox(
        "Select Commodity",
        commodities
    )
    
    # Region selection (if specific commodity selected)
    selected_region = None
    if selected_commodity != "All":
        regions = get_regions_for_commodity(selected_commodity)
        if regions:
            regions = ["All"] + regions
            selected_region = st.sidebar.selectbox(
                "Select Region",
                regions
            )
    
    # Add additional filters and options
    st.sidebar.markdown("---")
    st.sidebar.subheader("Advanced Options")
    
    time_period = st.sidebar.selectbox(
        "Time Period",
        ["1 Week", "1 Month", "3 Months", "6 Months", "1 Year"],
        index=1  # Default to 1 Month
    )
    
    st.sidebar.markdown("---")
    
    # About section
    st.sidebar.markdown("### About WIZX")
    st.sidebar.info(
        "WIZX is a comprehensive agricultural commodity pricing platform "
        "that leverages data crawling, machine learning, and interactive "
        "visualization to provide comprehensive market insights."
    )
    
    # Return selected values
    return selected_commodity, selected_region


def render_market_overview(commodity="All"):
    """Render market overview section"""
    st.header("Market Overview")
    
    # Get the WIZX index data
    if commodity == "All" or commodity is None:
        index_data = get_wizx_index()
        title = "WIZX Composite Index"
    else:
        index_data = get_wizx_index(commodity)
        title = f"{commodity} WIZX Index"
    
    if not index_data:
        st.warning(f"No index data available for {commodity}.")
        return
    
    # Extract index information
    current_value = index_data.get("current_value", 1000)
    change_percentage = index_data.get("change_percentage", 0)
    history = index_data.get("history", [])
    
    # Create columns for metrics
    col1, col2, col3 = st.columns(3)
    
    with col1:
        delta_color = "normal" if change_percentage == 0 else ("inverse" if change_percentage < 0 else "normal")
        st.metric(
            title,
            f"{current_value:.2f}",
            f"{change_percentage:+.2f}%",
            delta_color=delta_color
        )
    
    with col2:
        if history:
            min_value = min(point.get("value", 0) for point in history)
            max_value = max(point.get("value", 0) for point in history)
            range_percent = ((max_value - min_value) / min_value * 100) if min_value > 0 else 0
            
            st.metric(
                "Range (30d)",
                f"{min_value:.1f} - {max_value:.1f}",
                f"{range_percent:.1f}% volatility"
            )
    
    with col3:
        if len(history) >= 7:
            week_ago = history[-7]["value"] if len(history) >= 7 else current_value
            week_change = ((current_value - week_ago) / week_ago * 100) if week_ago > 0 else 0
            
            delta_color = "normal" if week_change == 0 else ("inverse" if week_change < 0 else "normal")
            st.metric(
                "Weekly Change",
                f"{week_change:+.2f}%",
                f"From {week_ago:.1f} a week ago",
                delta_color=delta_color
            )
    
    # Create line chart for price index history
    if history:
        df = pd.DataFrame(history)
        df['date'] = pd.to_datetime(df['date'])
        
        fig = px.line(
            df, 
            x='date', 
            y='value',
            title=f"{title} - Historical Trend",
            labels={"date": "Date", "value": "Index Value"}
        )
        
        # Add current value marker
        fig.add_trace(
            go.Scatter(
                x=[df['date'].iloc[-1]],
                y=[current_value],
                mode='markers',
                marker=dict(size=10, color='red'),
                name='Current Value'
            )
        )
        
        # Customize layout
        fig.update_layout(
            height=400,
            xaxis_title="Date",
            yaxis_title="Index Value",
            hovermode="x unified"
        )
        
        st.plotly_chart(fig, use_container_width=True)


def render_top_commodities():
    """Render top commodities section"""
    st.header("Top Commodities")
    
    # Get top commodities
    commodities = get_top_commodities(limit=5)
    
    if not commodities:
        st.warning("No commodity data available.")
        return
    
    # Create data for display
    data = []
    
    for commodity in commodities:
        index_data = get_wizx_index(commodity)
        
        if index_data:
            data.append({
                "Commodity": commodity,
                "Price Index": index_data.get("current_value", 0),
                "Change %": index_data.get("change_percentage", 0)
            })
    
    if data:
        # Convert to DataFrame
        df = pd.DataFrame(data)
        
        # Create columns for table and chart
        col1, col2 = st.columns([3, 5])
        
        with col1:
            # Apply conditional formatting for Change %
            def highlight_change(val):
                if val > 0:
                    return 'color: green'
                elif val < 0:
                    return 'color: red'
                return ''
            
            # Format the DataFrame
            df_styled = df.style.format({
                'Price Index': '{:.2f}',
                'Change %': '{:+.2f}%'
            }).applymap(highlight_change, subset=['Change %'])
            
            st.dataframe(df_styled, use_container_width=True)
        
        with col2:
            # Create bar chart of commodity prices
            fig = px.bar(
                df, 
                x='Commodity', 
                y='Price Index',
                color='Change %',
                color_continuous_scale=['red', 'yellow', 'green'],
                range_color=[-5, 5],
                title="Commodity Price Index Comparison"
            )
            
            # Add value labels
            fig.update_traces(
                texttemplate='%{y:.1f}',
                textposition='outside'
            )
            
            # Customize layout
            fig.update_layout(
                height=300,
                xaxis_title="Commodity",
                yaxis_title="Price Index",
                coloraxis_colorbar=dict(
                    title="Change %",
                )
            )
            
            st.plotly_chart(fig, use_container_width=True)


def render_regional_analysis(commodity):
    """Render regional analysis for a specific commodity"""
    if not commodity or commodity == "All":
        st.info("Please select a specific commodity to view regional analysis.")
        return
    
    st.header(f"Regional Analysis: {commodity}")
    
    # Get regions for this commodity
    regions = get_regions_for_commodity(commodity)
    
    if not regions:
        st.warning(f"No regional data available for {commodity}.")
        return
    
    # Create data for display
    data = []
    
    for region in regions:
        price_data = get_commodity_prices(commodity, region)
        
        if price_data:
            data.append({
                "Region": region,
                "Base Price": price_data.get("base_price", 0),
                "Quality Î”": price_data.get("quality_delta", 0),
                "Location Î”": price_data.get("location_delta", 0),
                "Market Î”": price_data.get("market_delta", 0),
                "Final Price": price_data.get("final_price", 0),
                "Rating": price_data.get("price_rating", "Unknown")
            })
    
    if data:
        # Convert to DataFrame
        df = pd.DataFrame(data)
        
        # Sort by final price
        df = df.sort_values("Final Price", ascending=False)
        
        # Create columns for table and chart
        col1, col2 = st.columns([3, 5])
        
        with col1:
            # Format the DataFrame
            df_styled = df.style.format({
                'Base Price': 'â‚¹{:.2f}',
                'Quality Î”': 'â‚¹{:.2f}',
                'Location Î”': 'â‚¹{:.2f}',
                'Market Î”': 'â‚¹{:.2f}',
                'Final Price': 'â‚¹{:.2f}'
            })
            
            st.dataframe(df_styled, use_container_width=True)
        
        with col2:
            # Create stacked bar chart of price components
            fig = go.Figure()
            
            # Add base price
            fig.add_trace(go.Bar(
                name='Base Price',
                x=df['Region'],
                y=df['Base Price'],
                marker_color='lightblue'
            ))
            
            # Add quality delta (only positive values)
            quality_positive = df['Quality Î”'].copy()
            quality_positive[quality_positive < 0] = 0
            fig.add_trace(go.Bar(
                name='Quality Premium',
                x=df['Region'],
                y=quality_positive,
                marker_color='green'
            ))
            
            # Add location delta (only positive values)
            location_positive = df['Location Î”'].copy()
            location_positive[location_positive < 0] = 0
            fig.add_trace(go.Bar(
                name='Location Premium',
                x=df['Region'],
                y=location_positive,
                marker_color='orange'
            ))
            
            # Add market delta (only positive values)
            market_positive = df['Market Î”'].copy()
            market_positive[market_positive < 0] = 0
            fig.add_trace(go.Bar(
                name='Market Premium',
                x=df['Region'],
                y=market_positive,
                marker_color='purple'
            ))
            
            # Add negative adjustments as a separate bar
            negative_adjustments = df['Quality Î”'].copy()
            negative_adjustments[negative_adjustments > 0] = 0
            negative_adjustments += df['Location Î”'].copy()
            negative_adjustments[df['Location Î”'] > 0] = 0
            negative_adjustments += df['Market Î”'].copy()
            negative_adjustments[df['Market Î”'] > 0] = 0
            
            if (negative_adjustments < 0).any():
                fig.add_trace(go.Bar(
                    name='Discounts',
                    x=df['Region'],
                    y=negative_adjustments,
                    marker_color='red'
                ))
            
            # Customize layout
            fig.update_layout(
                barmode='relative',
                title=f"{commodity} Price Components by Region",
                xaxis_title="Region",
                yaxis_title="Price (â‚¹)",
                height=400,
                legend=dict(
                    orientation="h",
                    yanchor="bottom",
                    y=1.02,
                    xanchor="right",
                    x=1
                )
            )
            
            st.plotly_chart(fig, use_container_width=True)


def render_quality_analysis(commodity):
    """Render quality analysis section for a specific commodity"""
    if not commodity or commodity == "All":
        st.info("Please select a specific commodity to view quality analysis.")
        return
    
    st.header(f"Quality Analysis: {commodity}")
    
    # Create example quality parameters
    quality_params = {}
    
    if commodity == "Wheat":
        quality_params = {
            "protein_content": 12.5,
            "moisture_content": 11.2,
            "test_weight": 79.5,
            "damaged_kernels": 0.8
        }
    elif commodity == "Rice":
        quality_params = {
            "broken_percentage": 7.2,
            "moisture_content": 12.0,
            "foreign_matter": 0.5,
            "head_rice_recovery": 78.0
        }
    else:
        # Generic parameters for other commodities
        quality_params = {
            "moisture_content": 12.5,
            "foreign_matter": 0.8
        }
    
    # Create columns for form and results
    col1, col2 = st.columns([2, 3])
    
    with col1:
        st.subheader("Quality Parameters")
        
        # Create form for quality parameters
        with st.form("quality_analysis_form"):
            # Dynamically create fields based on available parameters
            new_params = {}
            
            for param, value in quality_params.items():
                # Format parameter name for display
                param_display = param.replace("_", " ").title()
                
                # Create input field
                new_value = st.number_input(
                    f"{param_display}",
                    min_value=0.0,
                    max_value=100.0,
                    value=float(value),
                    step=0.1
                )
                
                new_params[param] = new_value
            
            # Add form submission button
            submit_button = st.form_submit_button("Analyze Quality")
            
            if submit_button:
                quality_params = new_params
    
    with col2:
        st.subheader("Analysis Results")
        
        # Perform quality analysis
        analysis = analyze_commodity_quality(commodity, quality_params)
        
        if analysis:
            score = analysis.get("quality_score", 0)
            grade = analysis.get("quality_grade", "C")
            summary = analysis.get("analysis_summary", "")
            
            # Display score gauge
            fig = go.Figure(go.Indicator(
                mode="gauge+number",
                value=score,
                domain={'x': [0, 1], 'y': [0, 1]},
                title={'text': f"Quality Score - Grade {grade}"},
                gauge={
                    'axis': {'range': [0, 100]},
                    'bar': {'color': "darkblue"},
                    'steps': [
                        {'range': [0, 65], 'color': "red"},
                        {'range': [65, 75], 'color': "orange"},
                        {'range': [75, 85], 'color': "yellow"},
                        {'range': [85, 95], 'color': "lightgreen"},
                        {'range': [95, 100], 'color': "green"},
                    ],
                    'threshold': {
                        'line': {'color': "red", 'width': 4},
                        'thickness': 0.75,
                        'value': score
                    }
                }
            ))
            
            fig.update_layout(height=300)
            st.plotly_chart(fig, use_container_width=True)
            
            # Display analysis summary
            st.markdown(f"**Analysis Summary:**")
            st.markdown(f"*{summary}*")
        else:
            st.warning("Unable to perform quality analysis. Please check parameters.")


def render_price_calculator(commodity, region=None):
    """Render price calculator for a specific commodity"""
    if not commodity or commodity == "All":
        st.info("Please select a specific commodity to use the price calculator.")
        return
    
    st.header(f"Price Calculator: {commodity}")
    
    # Get regions for this commodity
    regions = get_regions_for_commodity(commodity)
    
    if not regions:
        st.warning(f"No regional data available for {commodity}.")
        return
    
    # Create default quality parameters
    quality_params = {}
    
    if commodity == "Wheat":
        quality_params = {
            "protein_content": 12.5,
            "moisture_content": 11.2,
            "test_weight": 79.5,
            "damaged_kernels": 0.8
        }
    elif commodity == "Rice":
        quality_params = {
            "broken_percentage": 7.2,
            "moisture_content": 12.0,
            "foreign_matter": 0.5,
            "head_rice_recovery": 78.0
        }
    else:
        # Generic parameters for other commodities
        quality_params = {
            "moisture_content": 12.5,
            "foreign_matter": 0.8
        }
    
    # Create columns for form and results
    col1, col2 = st.columns([2, 3])
    
    with col1:
        st.subheader("Price Calculation Parameters")
        
        # Create form for price calculation
        with st.form("price_calculator_form"):
            # Region selection
            selected_region = st.selectbox(
                "Region",
                regions,
                index=0 if region is None else regions.index(region) if region in regions else 0
            )
            
            st.markdown("**Quality Parameters**")
            
            # Dynamically create fields based on available parameters
            new_params = {}
            
            for param, value in quality_params.items():
                # Format parameter name for display
                param_display = param.replace("_", " ").title()
                
                # Create input field
                new_value = st.number_input(
                    f"{param_display}",
                    min_value=0.0,
                    max_value=100.0,
                    value=float(value),
                    step=0.1
                )
                
                new_params[param] = new_value
            
            # Add form submission button
            submit_button = st.form_submit_button("Calculate Price")
            
            if submit_button:
                quality_params = new_params
                region = selected_region
    
    with col2:
        st.subheader("Price Results")
        
        # Calculate price
        price_result = calculate_price(commodity, quality_params, region)
        
        if price_result:
            base_price = price_result.get("base_price", 0)
            final_price = price_result.get("final_price", 0)
            quality_delta = price_result.get("quality_delta", 0)
            location_delta = price_result.get("location_delta", 0)
            market_delta = price_result.get("market_delta", 0)
            confidence = price_result.get("confidence", 0)
            price_rating = price_result.get("price_rating", "Unknown")
            
            # Display final price
            st.markdown(f"### Final Price: {format_price(final_price)}")
            st.markdown(f"**Rating:** {price_rating} (Confidence: {confidence*100:.1f}%)")
            
            # Create waterfall chart
            fig = go.Figure(go.Waterfall(
                name="Price Components",
                orientation="v",
                measure=["absolute", "relative", "relative", "relative", "total"],
                x=["Base Price", "Quality Adjustment", "Location Adjustment", "Market Adjustment", "Final Price"],
                textposition="outside",
                text=[f"+{base_price:.2f}", f"{quality_delta:+.2f}", f"{location_delta:+.2f}", f"{market_delta:+.2f}", f"={final_price:.2f}"],
                y=[base_price, quality_delta, location_delta, market_delta, 0],
                connector={"line": {"color": "rgb(63, 63, 63)"}},
            ))
            
            # Customize layout
            fig.update_layout(
                title=f"{commodity} Price Calculation for {region}",
                xaxis_title="Price Component",
                yaxis_title="Price (â‚¹)",
                showlegend=False,
                height=400
            )
            
            st.plotly_chart(fig, use_container_width=True)
            
            # Display price components as a table
            st.markdown("**Price Components**")
            
            components_df = pd.DataFrame({
                "Component": ["Base Price", "Quality Adjustment", "Location Adjustment", "Market Adjustment", "Final Price"],
                "Value (â‚¹)": [base_price, quality_delta, location_delta, market_delta, final_price],
                "Percentage": [
                    100.0,
                    (quality_delta / base_price * 100) if base_price > 0 else 0,
                    (location_delta / base_price * 100) if base_price > 0 else 0,
                    (market_delta / base_price * 100) if base_price > 0 else 0,
                    (final_price / base_price * 100) if base_price > 0 else 0
                ]
            })
            
            # Format the DataFrame
            components_df_styled = components_df.style.format({
                'Value (â‚¹)': 'â‚¹{:.2f}',
                'Percentage': '{:.1f}%'
            })
            
            st.dataframe(components_df_styled, use_container_width=True)
        else:
            st.warning("Unable to calculate price. Please check parameters.")


#------------------
# Main Application
#------------------

def main():
    """Main application entry point"""
    # Render header
    render_header()
    
    # Render sidebar and get selected values
    selected_commodity, selected_region = render_sidebar()
    
    # Check if database needs initialization
    if selected_commodity is None:
        st.warning("Database not initialized. Please use the Initialize Database button in the sidebar.")
        return
    
    # Create tabs for different views
    tab1, tab2, tab3 = st.tabs(["Dashboard", "Price Calculator", "Quality Analysis"])
    
    with tab1:
        # Dashboard view
        st.markdown("## Market Dashboard")
        
        # Render market overview
        render_market_overview(selected_commodity)
        
        # If "All" is selected, show top commodities
        if selected_commodity == "All":
            render_top_commodities()
        else:
            # If specific commodity is selected, show regional analysis
            render_regional_analysis(selected_commodity)
    
    with tab2:
        # Price calculator view
        render_price_calculator(selected_commodity, selected_region)
    
    with tab3:
        # Quality analysis view
        render_quality_analysis(selected_commodity)


if __name__ == "__main__":
    main()